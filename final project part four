<?php
include 'db_connect.php'; 

$message = "";
$company = [];
$id = isset($_GET['id']) ? $_GET['id'] : (isset($_POST['id']) ? $_POST['id'] : null);

if (!$id) {
    echo "Corporate ID not specified.";
    
    if (isset($connection)) mysqli_close($connection);
    exit();
}

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $company_name = $_POST['company_name'];
    $email = $_POST['email'];
    $phone = $_POST['phone'];
    $password_input = $_POST['password']; 

    if (!empty($password_input)) {
        
        $hashed_password = hash('sha256', $password_input);
        
        $sql_update = "UPDATE Corporate SET 
                       Company_name = ?, 
                       email = ?, 
                       phone = ?,
                       password = ?
                       WHERE ID = ?";
        
        $stmt_update = mysqli_prepare($connection, $sql_update);
        
        mysqli_stmt_bind_param($stmt_update, "ssssi", $company_name, $email, $phone, $hashed_password, $id);
        
    } else {
        
        $sql_update = "UPDATE Corporate SET 
                       Company_name = ?, 
                       email = ?, 
                       phone = ?
                       WHERE ID = ?";
        
        $stmt_update = mysqli_prepare($connection, $sql_update);
        
        mysqli_stmt_bind_param($stmt_update, "sssi", $company_name, $email, $phone, $id);
    }
    
    
    if (mysqli_stmt_execute($stmt_update)) {
        mysqli_stmt_close($stmt_update);
        mysqli_close($connection);
        header("Location: corporate_index.php"); 
        exit();
    } else {
        $message = "Update Error: " . mysqli_error($connection);
        mysqli_stmt_close($stmt_update);
    }
}


$sql_select = "SELECT ID, Company_name, email, phone FROM Corporate WHERE ID = ?";
$stmt_select = mysqli_prepare($connection, $sql_select);
mysqli_stmt_bind_param($stmt_select, "i", $id);

if (mysqli_stmt_execute($stmt_select)) {
    $result = mysqli_stmt_get_result($stmt_select);
    if (mysqli_num_rows($result) > 0) {
        $company = mysqli_fetch_assoc($result);
    } else {
        $message = "Corporate not found.";
    }
} else {
    $message = "Database Error during fetch: " . mysqli_error($connection);
}
mysqli_stmt_close($stmt_select);


if (isset($connection) && !headers_sent()) {
    mysqli_close($connection);
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Corporate Details</title>
    c
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5 col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0">Edit Corporate: <?php echo htmlspecialchars($company['Company_name'] ?? ''); ?></h4>
            </div>
            <div class="card-body">
                <?php if ($message): ?>
                    <div class="alert alert-danger" role="alert"><?php echo $message; ?></div>
                <?php endif; ?>
                
                <form method="post" action="corporate_edit.php">
                    <input type="hidden" name="id" value="<?php echo htmlspecialchars($company['ID'] ?? ''); ?>">
                    
                    <div class="mb-3">
                        <label for="company_name" class="form-label">Company Name:</label>
                        <input type="text" id="company_name" name="company_name" class="form-control" value="<?php echo htmlspecialchars($company['Company_name'] ?? ''); ?>" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email:</label>
                        <input type="email" id="email" name="email" class="form-control" value="<?php echo htmlspecialchars($company['email'] ?? ''); ?>" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone:</label>
                        <input type="text" id="phone" name="phone" class="form-control" value="<?php echo htmlspecialchars($company['phone'] ?? ''); ?>">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">New Password (Leave blank to keep current):</label>
                        <input type="password" id="password" name="password" class="form-control">
                        <small class="form-text text-muted">The current password will be preserved if this field is empty.</small>
                    </div>
                    <button type="submit" class="btn btn-primary me-2">Save Changes</button>
                    <a href="corporate_index.php" class="btn btn-outline-secondary">Back to List</a>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
